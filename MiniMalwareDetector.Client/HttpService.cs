using System.Net.Http.Headers;
using Microsoft.AspNetCore.Http;

namespace MiniMalwareDetector.Client;

public class HttpService
{
    private HttpClient _client = new HttpClient();
    private string _uri = "https://localhost:7282/api/Scan";

    public async Task<string> SendFilesForScan()
    {
        var filePath = @"C:\Users\ilyap\Desktop\MalwareDetector-service-master\MalwareDetector.Test\TestDirectory\SubDir_1\babel.config_MALWARE.js";
        var fileName = Path.GetFileName(filePath);
        
        var stream = new MemoryStream(File.ReadAllBytes(filePath).ToArray());
        FormFile file = new FormFile(stream, 0, stream.Length, filePath, Path.GetFileName(filePath));
        
        var content = new MultipartFormDataContent();
        var fileContent = new StreamContent(file.OpenReadStream());
        fileContent.Headers.ContentDisposition = new ContentDispositionHeaderValue("form-data")
        {
            Name = "formFiles",
            FileName = fileName
        };
        fileContent.Headers.ContentType = new MediaTypeHeaderValue("file/*");
        
        content.Add(fileContent);
        var response = await _client.PostAsync($"{_uri}/321", content); 
        var test = await response.Content.ReadAsStringAsync();
        return test;
    }
}